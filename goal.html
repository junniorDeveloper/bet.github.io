<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estrategia de Bank Progresivo</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --text-primary: #000000;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-color: #e5e5e5;
      --card-bg: #ffffff;
      --card-border: #d1d5db;
      --hover-bg: #f5f5f5;
      --active-bg: #000000;
      --active-text: #ffffff;
      --shadow: rgba(0, 0, 0, 0.08);
    }

    [data-theme="dark"] {
      --bg-primary: #0a0a0a;
      --bg-secondary: #141414;
      --text-primary: #ffffff;
      --text-secondary: #a3a3a3;
      --text-tertiary: #737373;
      --border-color: #262626;
      --card-bg: #171717;
      --card-border: #262626;
      --hover-bg: #262626;
      --active-bg: #ffffff;
      --active-text: #000000;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding-top: 65px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .checkbox-animation {
      transition: all 0.2s ease;
    }

    .mono-font {
      font-family: 'JetBrains Mono', monospace;
    }

    .filter-btn {
      transition: all 0.2s ease;
      background: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .filter-btn:hover {
      background: var(--hover-bg);
    }

    .filter-btn.active {
      background: var(--active-bg);
      color: var(--active-text);
    }

    /* Navbar Fixed */
    .navbar-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 65px;
      left: 0;
      bottom: 0;
      width: 280px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-color);
      transform: translateX(-100%);
      transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
      z-index: 40;
      overflow-y: auto;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-overlay {
      position: fixed;
      top: 65px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 30;
    }

    .sidebar-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    /* Desktop adjustments */
    @media (min-width: 768px) {
      body {
        padding-top: 65px;
      }
    }

    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }

    /* Theme toggle button */
    .theme-toggle {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--hover-bg);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const BettingStrategyApp = () => {
      const [goals, setGoals] = useState([]);
      const [loading, setLoading] = useState(true);
      const [currentGoalIndex, setCurrentGoalIndex] = useState(0);
      const [filterView, setFilterView] = useState('all'); // all, active, completed
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [theme, setTheme] = useState('light');
      const goalRefs = useRef([]);

      useEffect(() => {
        loadData();
        // Cargar tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        document.documentElement.setAttribute('data-theme', savedTheme);
      }, []);

      const loadData = async () => {
        try {
          const API_URL = 'https://script.google.com/macros/s/AKfycbyd-FbN3BS0BRjWYK7sLp5XhKtavb2oNrm2ywYmv-0BcoiO_HN9NdstsQAO-1WDs3we/exec';
          const response = await fetch(`${API_URL}?ruta=api/v1/data`);
          const result = await response.json();

          if (result.success && result.data) {
            setGoals(result.data);

            const firstIncomplete = result.data.findIndex(g => !g.completed);
            setCurrentGoalIndex(firstIncomplete !== -1 ? firstIncomplete : result.data.length - 1);
          } else {
            console.error('Error en la respuesta de la API:', result);
          }

          setLoading(false);
        } catch (error) {
          console.error('Error loading data:', error);
          setLoading(false);
        }
      };

      const toggleGoalCompletion = async (goalId) => {
        const goalToUpdate = goals.find(g => g.id === goalId);
        if (!goalToUpdate) return;

        const newCompleted = !goalToUpdate.completed;

        // Actualizar localmente primero para UX rápida
        const updatedGoals = goals.map(goal => {
          if (goal.id === goalId) {
            return {
              ...goal,
              completed: newCompleted
            };
          }
          return goal;
        });

        setGoals(updatedGoals);

        // Preparar datos para el POST
        const dataToSend = {
          ...goalToUpdate,
          completed: newCompleted
        };

        // Enviar POST a la API
        try {
          const API_URL = 'https://script.google.com/macros/s/AKfycbyd-FbN3BS0BRjWYK7sLp5XhKtavb2oNrm2ywYmv-0BcoiO_HN9NdstsQAO-1WDs3we/exec';

          const response = await fetch(`${API_URL}?ruta=api/v1/data/update`, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(dataToSend)
          });

          console.log('Actualización completada');

        } catch (error) {
          console.error('Error al actualizar:', error);
          // Revertir cambios locales si falla
          loadData();
        }

        // Actualizar el índice del objetivo actual
        const firstIncomplete = updatedGoals.findIndex(g => !g.completed);
        setCurrentGoalIndex(firstIncomplete !== -1 ? firstIncomplete : updatedGoals.length - 1);
      };

      const scrollToCurrentGoal = () => {
        if (goalRefs.current[currentGoalIndex]) {
          goalRefs.current[currentGoalIndex].scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }
        setSidebarOpen(false);
      };

      const handleFilterChange = (filter) => {
        setFilterView(filter);
        setSidebarOpen(false);
      };

      const toggleSidebar = () => {
        setSidebarOpen(!sidebarOpen);
      };

      const toggleTheme = () => {
        const newTheme = theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      };

      const getFilteredGoals = () => {
        if (filterView === 'active') return goals.filter(g => !g.completed);
        if (filterView === 'completed') return goals.filter(g => g.completed);
        return goals;
      };

      const getCompletedCount = () => goals.filter(g => g.completed).length;
      const getTotalProfit = () => {
        return goals.reduce((acc, goal) => {
          if (goal.completed) return acc + goal.targetProfit;
          return acc;
        }, 0);
      };

      if (loading) {
        return (
          <div className="min-h-[90vh] flex items-center justify-center bg-white">
            <div className="text-black text-lg">
              <i className="fas fa-spinner fa-spin mr-2"></i>
              Cargando estrategia...
            </div>
          </div>
        );
      }

      const filteredGoals = getFilteredGoals();

      return (
        <div className="min-h-screen" style={{background: 'var(--bg-primary)'}}>
          {/* Navbar Fixed */}
          <nav className="navbar-fixed">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                {/* Logo/Title */}
                <div className="flex items-center gap-3">
                  <button
                    onClick={toggleSidebar}
                    className="md:hidden p-2 rounded-lg transition-colors"
                  >
                    <i className="fas fa-bars text-xl"></i>
                  </button>
                  <h1 className="text-xl md:text-2xl font-semibold" style={{ color: 'var(--text-primary)' }}>
                    Estrategia Progresiva
                  </h1>
                </div>

                {/* Desktop Filters */}
                <div className="hidden md:flex items-center gap-3">
                 <button
                      onClick={() => handleFilterChange('all')}
                      className={`filter-btn px-4 py-2 rounded-lg text-sm font-medium ${
                          filterView === 'all' ? 'active' : ''
                      }`}
                  >
                      Todos ({goals.length})
                  </button>

                  <button
                      onClick={() => handleFilterChange('active')}
                      className={`filter-btn px-4 py-2 rounded-lg text-sm font-medium ${
                          filterView === 'active' ? 'active' : ''
                      }`}
                  >
                      Activos ({goals.filter(g => !g.completed).length})
                  </button>

                  <button
                      onClick={() => handleFilterChange('completed')}
                      className={`filter-btn px-4 py-2 rounded-lg text-sm font-medium ${
                          filterView === 'completed' ? 'active' : ''
                      }`}
                  >
                      Completados ({getCompletedCount()})
                  </button>


                  {/* Theme Toggle Desktop */}
                  <div style={{ width: '1px', height: '24px', background: 'var(--border-color)' }}></div>
                  <button
                    onClick={toggleTheme}
                    className="theme-toggle px-4 py-1.5 rounded-md"
                    title={theme === 'light' ? 'Cambiar a modo oscuro' : 'Cambiar a modo claro'}
                  >
                    <i className={`fas ${theme === 'light' ? 'fa-moon' : 'fa-sun'}`}></i>
                  </button>

                  <div style={{ width: '1px', height: '24px', background: 'var(--border-color)' }}></div>
                  <button
                    onClick={() => window.location.href = 'betting.html'}
                    className="theme-toggle px-4 py-1.5 rounded-md"
                  >
                    <i class="fa-solid fa-house"></i>
                  </button>
                </div>

                {/* Go to Current Button */}
                <button
                  onClick={scrollToCurrentGoal}
                  className="px-4 py-2 rounded-lg text-sm font-medium transition-all"
                  style={{
                    background: 'var(--active-bg)',
                    color: 'var(--active-text)'
                  }}
                >
                  <i className="fas fa-crosshairs sm:mr-2"></i>
                  <span className="hidden sm:inline">Ir al objetivo</span>
                </button>
              </div>
            </div>
          </nav>

          {/* Sidebar Overlay */}
          <div
            className={`sidebar-overlay ${sidebarOpen ? 'open' : ''}`}
            onClick={() => setSidebarOpen(false)}
          ></div>

          {/* Sidebar (Mobile) */}
          <aside className={`sidebar md:hidden ${sidebarOpen ? 'open' : ''}`}>
            <div className="p-6">
              <h2 className="text-sm font-semibold uppercase tracking-wide mb-4" style={{ color: 'var(--text-secondary)' }}>
                Filtros
              </h2>
              <div className="space-y-2">
                <button
                  onClick={() => handleFilterChange('all')}
                  className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium ${filterView === 'all' ? 'filter-btn active' : 'filter-btn'
                    }`}
                >
                  <i className="fas fa-list mr-3"></i>
                  Todos
                  <span className="float-right mono-font">{goals.length}</span>
                </button>
                <button
                  onClick={() => handleFilterChange('active')}
                  className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium ${filterView === 'active' ? 'filter-btn active' : 'filter-btn'
                    }`}
                >
                  <i className="fas fa-circle-dot mr-3"></i>
                  Activos
                  <span className="float-right mono-font">{goals.filter(g => !g.completed).length}</span>
                </button>
                <button
                  onClick={() => handleFilterChange('completed')}
                  className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium ${filterView === 'completed' ? 'filter-btn active' : 'filter-btn'
                    }`}
                >
                  <i className="fas fa-check-circle mr-3"></i>
                  Completados
                  <span className="float-right mono-font">{getCompletedCount()}</span>
                </button>
              </div>

              <div className="mt-6 pt-6" style={{ borderTop: '1px solid var(--border-color)' }}>
                <h2 className="text-sm font-semibold uppercase tracking-wide mb-3" style={{ color: 'var(--text-secondary)' }}>
                  Apariencia
                </h2>
                <button
                  onClick={toggleTheme}
                  className="w-full theme-toggle px-4 py-3 rounded-lg text-sm font-medium flex items-center justify-between"
                >
                  <span>
                    <i className={`fas ${theme === 'light' ? 'fa-moon' : 'fa-sun'} mr-3`}></i>
                    {theme === 'light' ? 'Modo Oscuro' : 'Modo Claro'}
                  </span>
                  <i className="fas fa-chevron-right text-xs" style={{ color: 'var(--text-tertiary)' }}></i>
                </button>
              </div>

              <div className=" mt-4 ">
                <h2 className="text-sm font-semibold uppercase tracking-wide mb-3" style={{color: 'var(--text-secondary)'}}>
                    Ir al Inicio
                </h2>
                <button
                    onClick={() => window.location.href = 'betting.html'}
                    className="w-full theme-toggle px-4 py-3 rounded-lg text-sm font-medium flex items-center justify-between"
                >
                    <span>
                      <i class="fa-solid fa-house mr-2"></i>
                        Inicio
                    </span>
                </button>
              </div>

              <div className="mt-6 pt-6" style={{ borderTop: '1px solid var(--border-color)' }}>
                <p className="text-xs mb-2" style={{ color: 'var(--text-tertiary)' }}>Cuotas: 1.70 - 2.00</p>
                <p className="text-xs" style={{ color: 'var(--text-tertiary)' }}>2 apuestas diarias</p>
              </div>
            </div>
          </aside>

          {/* Main Content */}
          <div className="py-6 px-4">
            <div className="max-w-7xl mx-auto">
              {/* Stats */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="rounded-lg p-5" style={{ border: '1px solid var(--border-color)', background: 'var(--card-bg)' }}>
                  <div className="text-2xl font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>{getCompletedCount()}/{goals.length}</div>
                  <div className="text-xs mt-1 uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Objetivos completados</div>
                </div>
                <div className="rounded-lg p-5" style={{ border: '1px solid var(--border-color)', background: 'var(--card-bg)' }}>
                  <div className="text-2xl font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>S/ {getTotalProfit()}</div>
                  <div className="text-xs mt-1 uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Ganancia acumulada</div>
                </div>
                <div className="rounded-lg p-5" style={{ border: '1px solid var(--border-color)', background: 'var(--card-bg)' }}>
                  <div className="text-2xl font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>
                    {goals[currentGoalIndex] ? `S/ ${goals[currentGoalIndex].currentBank}` : '-'}
                  </div>
                  <div className="text-xs mt-1 uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Bank actual</div>
                </div>
              </div>

              {/* Goals Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredGoals.map((goal, index) => {
                  const originalIndex = goals.findIndex(g => g.id === goal.id);
                  return (
                    <div
                      key={goal.id}
                      ref={el => goalRefs.current[originalIndex] = el}
                      className={`rounded-lg p-5 ${goal.completed ? 'opacity-60' : ''
                        } ${originalIndex === currentGoalIndex ? 'ring-2 ring-black' : ''}`}
                      style={{
                        border: `1px solid var(--border-color)`,
                        background: 'var(--card-bg)',
                        ringColor: 'var(--text-primary)'
                      }}
                    >
                      {/* Card Header */}
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                          <div className={`w-9 h-9 rounded-lg flex items-center justify-center text-sm font-semibold`}
                            style={{
                              background: goal.completed ? 'var(--text-tertiary)' : 'var(--active-bg)',
                              color: goal.completed ? 'var(--active-text)' : 'var(--active-text)'
                            }}
                          >
                            {goal.id}
                          </div>
                          <div>
                            <div className="font-semibold mono-font text-sm" style={{ color: 'var(--text-primary)' }}>
                              S/ {goal.currentBank}
                            </div>
                            <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>{goal.daysRange}</div>
                          </div>
                        </div>
                        <label className="relative inline-flex items-center cursor-pointer">
                          <input
                            type="checkbox"
                            checked={goal.completed}
                            onChange={() => toggleGoalCompletion(goal.id)}
                            className="sr-only peer checkbox-animation"
                          />
                          <div className="w-10 h-5 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"
                            style={{
                              background: goal.completed ? 'var(--active-bg)' : 'var(--text-tertiary)',
                              border: `1px solid var(--border-color)`
                            }}
                          ></div>
                        </label>
                      </div>

                      {/* Stats */}
                      <div className="space-y-2.5">
                        <div className="flex justify-between text-xs">
                          <span className="uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Meta</span>
                          <span className="font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>+ S/ {goal.targetProfit}</span>
                        </div>
                        <div className="flex justify-between text-xs">
                          <span className="uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Próximo</span>
                          <span className="font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>S/ {goal.nextBank}</span>
                        </div>
                        <div className="flex justify-between text-xs">
                          <span className="uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Apuesta</span>
                          <span className="font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>S/ {goal.betAmount}</span>
                        </div>
                        <div className="flex justify-between text-xs">
                          <span className="uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>Victorias</span>
                          <span className="font-semibold mono-font" style={{ color: 'var(--text-primary)' }}>{goal.winsNeeded}</span>
                        </div>
                      </div>

                      {goal.completed && (
                        <div className="mt-4 pt-3 text-center" style={{ borderTop: '1px solid var(--border-color)' }}>
                          <span className="font-medium text-xs uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>
                            <i className="fas fa-check-circle mr-1"></i>
                            Completado
                          </span>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              {/* Footer */}
              <div className="text-center mt-8 text-xs uppercase tracking-wide" style={{ color: 'var(--text-tertiary)' }}>
                Estrategia de gestión de bankroll progresiva
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<BettingStrategyApp />, document.getElementById('root'));
  </script>
</body>

</html>